<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.easychat.mapper.AppUpdateMapper">

		<!--实体映射-->
		<resultMap id="base_result_map" type="com.easychat.entity.po.AppUpdate">
			<!--自增加-->
			<id column="id" property="id"  />
			<!--版本号-->
			<result column="version" property="version"  />
			<!--更新描述-->
			<result column="update_date" property="updateDate"  />
			<!--创建时间-->
			<result column="create_time" property="createTime"  />
			<!--负责运行日志或发布 1:全局发布-->
			<result column="status" property="status"  />
			<!--完整uid-->
			<result column="greyscale_id" property="greyscaleId"  />
			<!--文件类型0:本地文件 1:外延-->
			<result column="file_type" property="fileType"  />
			<!--外延地址-->
			<result column="outer_link" property="outerLink"  />
		</resultMap>
		<!--通用查询结果列-->
		<sql id="base_column_list">
		id,version,update_date,create_time,status,greyscale_id,file_type,outer_link
		</sql>
		<!--基础查询条件-->
		<sql id="base_query_condition">
			<if test="query.id!=null">
				and id=#{query.id}
			</if>
			<if test="query.version!=null">
				and version=#{query.version}
			</if>
			<if test="query.updateDate!=null">
				and update_date=#{query.updateDate}
			</if>
			<if test="query.createTime!=null">
				and create_time=#{query.createTime}
			</if>
			<if test="query.status!=null">
				and status=#{query.status}
			</if>
			<if test="query.greyscaleId!=null">
				and greyscale_id=#{query.greyscaleId}
			</if>
			<if test="query.fileType!=null">
				and file_type=#{query.fileType}
			</if>
			<if test="query.outerLink!=null">
				and outer_link=#{query.outerLink}
			</if>
		</sql>

		<!--拓展查询条件-->
	<sql id="base_query_condition_extend">
			<if test="query.versionFuzzy!=null and query.versionFuzzy!=''">
				and version like concat('%', #{versionFuzzy}, '%')
			</if>
			<if test="query.updateDateFuzzy!=null and query.updateDateFuzzy!=''">
				and update_date like concat('%', #{updateDateFuzzy}, '%')
			</if>
			<if test="query.createTimeStart!=null and query.createTimeStart!=''">
				<![CDATA[ and create_time>=str_to_date(#{query.createTimeStart}, '%Y-%m-%d')  ]]>
			</if>
			<if test="query.createTimeEnd!=null and query.createTimeEnd!=''">
				<![CDATA[ and create_time<date_sub(str_to_date(#{query.createTimeEnd}, '%Y-%m-%d'),interval -1 day)  ]]>
			</if>
			<if test="query.greyscaleIdFuzzy!=null and query.greyscaleIdFuzzy!=''">
				and greyscale_id like concat('%', #{greyscaleIdFuzzy}, '%')
			</if>
			<if test="query.outerLinkFuzzy!=null and query.outerLinkFuzzy!=''">
				and outer_link like concat('%', #{outerLinkFuzzy}, '%')
			</if>
		</sql>
		<!--通用条件列-->
		<sql id="query_condition">
			<where>
				<include refid="base_query_condition"/>
				<include refid="base_query_condition_extend"/>
			</where>
		</sql>
	<!--查询集合-->
	<select id="selectList" resultMap="base_result_map">
		SELECT
			<include refid="base_column_list"/>
			FROM app_update
			<include refid="query_condition"/>
			<if test="query.orderBy!=null">
				order by ${query.orderBy}
			</if>
			<if test="query.simplePage!=null">
				limit #{query.simplePage.start},#{query.simplePage.end}
			</if>
		</select>
	<!--查询数量-->
	<select id="selectCount" resultType="java.lang.Integer">
		SELECT count(1) FROM app_update<include refid="query_condition"/>
	</select>
	<!--插入（匹配有值的字段）-->
		<insert id="insert" parameterType="com.easychat.entity.po.AppUpdate">
			<selectKey keyProperty="bean.id" resultType="Integer" order="AFTER">
				SELECT LAST_INSERT_ID()
			</selectKey>
			INSERT INTO app_update
			<trim prefix="(" suffix=")" suffixOverrides=",">
				<if test="bean.id!=null">
					id,
				</if>
				<if test="bean.version!=null">
					version,
				</if>
				<if test="bean.updateDate!=null">
					update_date,
				</if>
				<if test="bean.createTime!=null">
					create_time,
				</if>
				<if test="bean.status!=null">
					status,
				</if>
				<if test="bean.greyscaleId!=null">
					greyscale_id,
				</if>
				<if test="bean.fileType!=null">
					file_type,
				</if>
				<if test="bean.outerLink!=null">
					outer_link,
				</if>
			</trim>
			<trim prefix="values(" suffix=")" suffixOverrides=",">
				<if test="bean.id!=null">
					#{bean.id},
				</if>
				<if test="bean.version!=null">
					#{bean.version},
				</if>
				<if test="bean.updateDate!=null">
					#{bean.updateDate},
				</if>
				<if test="bean.createTime!=null">
					#{bean.createTime},
				</if>
				<if test="bean.status!=null">
					#{bean.status},
				</if>
				<if test="bean.greyscaleId!=null">
					#{bean.greyscaleId},
				</if>
				<if test="bean.fileType!=null">
					#{bean.fileType},
				</if>
				<if test="bean.outerLink!=null">
					#{bean.outerLink},
				</if>
			</trim>
		</insert>
	<!--插入或更新（匹配有值的字段）-->
	<insert id="insertOrUpdate" parameterType="com.easychat.entity.po.AppUpdate">
		INSERT INTO app_update
		<trim prefix="(" suffix=")" suffixOverrides=",">
				<if test="bean.id!=null">
					id,
				</if>
				<if test="bean.version!=null">
					version,
				</if>
				<if test="bean.updateDate!=null">
					update_date,
				</if>
				<if test="bean.createTime!=null">
					create_time,
				</if>
				<if test="bean.status!=null">
					status,
				</if>
				<if test="bean.greyscaleId!=null">
					greyscale_id,
				</if>
				<if test="bean.fileType!=null">
					file_type,
				</if>
				<if test="bean.outerLink!=null">
					outer_link,
				</if>
			</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="bean.id!=null">
				#{bean.id},
			</if>
			<if test="bean.version!=null">
				#{bean.version},
			</if>
			<if test="bean.updateDate!=null">
				#{bean.updateDate},
			</if>
			<if test="bean.createTime!=null">
				#{bean.createTime},
			</if>
			<if test="bean.status!=null">
				#{bean.status},
			</if>
			<if test="bean.greyscaleId!=null">
				#{bean.greyscaleId},
			</if>
			<if test="bean.fileType!=null">
				#{bean.fileType},
			</if>
			<if test="bean.outerLink!=null">
				#{bean.outerLink},
			</if>
		</trim>
		on DUPLICATE key update
		<trim prefix="" suffix="" suffixOverrides=",">
			<if test="bean.updateDate!=null">
				update_date=VALUES(update_date),
			</if>
			<if test="bean.createTime!=null">
				create_time=VALUES(create_time),
			</if>
			<if test="bean.status!=null">
				status=VALUES(status),
			</if>
			<if test="bean.greyscaleId!=null">
				greyscale_id=VALUES(greyscale_id),
			</if>
			<if test="bean.fileType!=null">
				file_type=VALUES(file_type),
			</if>
			<if test="bean.outerLink!=null">
				outer_link=VALUES(outer_link),
			</if>
		</trim>
	</insert>
	<!--添加(批量插入)-->
	<insert id="insertBatch" parameterType="com.easychat.entity.po.AppUpdate" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO app_update(version,update_date,create_time,status,greyscale_id,file_type,outer_link) VALUES
		<foreach collection="list" item="item" separator=",">
			(
			#{item.version},#{item.updateDate},#{item.createTime},#{item.status},#{item.greyscaleId},#{item.fileType},#{item.outerLink}
			)
		</foreach>
	</insert>
	<!--批量新增修改(批量插入)-->
	<insert id="insertOrUpdateBatch" parameterType="com.easychat.entity.po.AppUpdate">
		INSERT INTO app_update(version,update_date,create_time,status,greyscale_id,file_type,outer_link) VALUES
		<foreach collection="list" item="item" separator=",">
			(
			#{item.version},#{item.updateDate},#{item.createTime},#{item.status},#{item.greyscaleId},#{item.fileType},#{item.outerLink}
			)
		</foreach>
		on DUPLICATE key update
		version=VALUES(version),
		update_date=VALUES(update_date),
		create_time=VALUES(create_time),
		status=VALUES(status),
		greyscale_id=VALUES(greyscale_id),
		file_type=VALUES(file_type),
		outer_link=VALUES(outer_link)
	</insert>
	<!--根据Id查询-->
	<select id="selectById" resultMap="base_result_map">
		select <include refid="base_column_list"/> from app_update where id=#{id}
	</select>
	<!--根据Id更新-->
<update id="updateById" parameterType="com.easychat.entity.po.AppUpdate">
		UPDATE app_update
		<set>
			<if test="bean.id!=null">
				id=#{bean.id},
			</if>
			<if test="bean.version!=null">
				version=#{bean.version},
			</if>
			<if test="bean.updateDate!=null">
				update_date=#{bean.updateDate},
			</if>
			<if test="bean.createTime!=null">
				create_time=#{bean.createTime},
			</if>
			<if test="bean.status!=null">
				status=#{bean.status},
			</if>
			<if test="bean.greyscaleId!=null">
				greyscale_id=#{bean.greyscaleId},
			</if>
			<if test="bean.fileType!=null">
				file_type=#{bean.fileType},
			</if>
			<if test="bean.outerLink!=null">
				outer_link=#{bean.outerLink},
			</if>
		</set>
		where id=#{id}
	</update>
	<!--根据Id删除-->
	<delete id="deleteById">
		delete from app_update where id=#{id}
	</delete>
	<!--根据Version查询-->
	<select id="selectByVersion" resultMap="base_result_map">
		select <include refid="base_column_list"/> from app_update where version=#{version}
	</select>
    <select id="selectLatestUpdate"  resultMap="base_result_map">
       select
           <include refid="base_column_list"/>
           from app_update where version>#{appVersion} and (status=2 or(status=1 and
                              FIND_IN_SET(#{uid},greyscale_id) ) )
       order by id desc limit 0,1
	</select>
    <!--根据Version更新-->
<update id="updateByVersion" parameterType="com.easychat.entity.po.AppUpdate">
		UPDATE app_update
		<set>
			<if test="bean.id!=null">
				id=#{bean.id},
			</if>
			<if test="bean.version!=null">
				version=#{bean.version},
			</if>
			<if test="bean.updateDate!=null">
				update_date=#{bean.updateDate},
			</if>
			<if test="bean.createTime!=null">
				create_time=#{bean.createTime},
			</if>
			<if test="bean.status!=null">
				status=#{bean.status},
			</if>
			<if test="bean.greyscaleId!=null">
				greyscale_id=#{bean.greyscaleId},
			</if>
			<if test="bean.fileType!=null">
				file_type=#{bean.fileType},
			</if>
			<if test="bean.outerLink!=null">
				outer_link=#{bean.outerLink},
			</if>
		</set>
		where version=#{version}
	</update>
	<!--根据Version删除-->
	<delete id="deleteByVersion">
		delete from app_update where version=#{version}
	</delete>
</mapper>